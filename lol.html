<!DOCTYPE html>
<html>
<head>
  <title>Basic Tetris HTML Game </title>
  <meta charset="UTF-8">
  <style>
    html, body {
      height: 100%;
      margin: 0;
    }
    body {
      background: black;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    canvas {
      border: 1px solid white;
    }
  </style>
</head>
<body>
<canvas width="320" height="640" id="game"></canvas>
<script>
let gamepadIndex = null;

// Listen for gamepad connection
window.addEventListener("gamepadconnected", (event) => {
  gamepadIndex = event.gamepad.index;
  console.log("Gamepad connected:", event.gamepad.id);
});

// Listen for gamepad disconnection
window.addEventListener("gamepaddisconnected", () => {
  gamepadIndex = null;
  console.log("Gamepad disconnected");
});

// Check gamepad input
function handleGamepadInput() {
  if (gamepadIndex === null) return;
  
  const gamepad = navigator.getGamepads()[gamepadIndex];
  if (!gamepad) return;
  
  // PS4 D-pad mappings
  const dpadUp = gamepad.buttons[12].pressed;
  const dpadDown = gamepad.buttons[13].pressed;
  const dpadLeft = gamepad.buttons[14].pressed;
  const dpadRight = gamepad.buttons[15].pressed;
  const crossButton = gamepad.buttons[0].pressed; // "X" button for hard drop

  if (dpadLeft) moveTetromino(-1);
  if (dpadRight) moveTetromino(1);
  if (dpadUp) rotateTetromino();
  if (dpadDown) softDrop();
  if (crossButton) hardDrop();
}

// Function to move the tetromino left/right
function moveTetromino(direction) {
  const newCol = tetromino.col + direction;
  if (isValidMove(tetromino.matrix, tetromino.row, newCol)) {
    tetromino.col = newCol;
  }
}

// Function to rotate the tetromino
function rotateTetromino() {
  const newMatrix = rotate(tetromino.matrix);
  if (isValidMove(newMatrix, tetromino.row, tetromino.col)) {
    tetromino.matrix = newMatrix;
  }
}

// Function to soft drop
function softDrop() {
  const newRow = tetromino.row + 1;
  if (!isValidMove(tetromino.matrix, newRow, tetromino.col)) {
    tetromino.row = newRow - 1;
    placeTetromino();
  } else {
    tetromino.row = newRow;
  }
}

// Function to hard drop
function hardDrop() {
  while (isValidMove(tetromino.matrix, tetromino.row + 1, tetromino.col)) {
    tetromino.row++;
  }
  placeTetromino();
}

// Modify the game loop to check for controller input
function loop() {
  handleGamepadInput();
  requestAnimationFrame(loop);
}

// Start the game loop
requestAnimationFrame(loop);
</script>
</body>
</html>
